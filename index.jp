

const express = require('express');
const bodyParser = require('body-parser');
const axios = require('axios');
const app = express();
app.use(bodyParser.json());
// LINE設定
require('dotenv').config();

const CHANNEL_SECRET = process.env.CHANNEL_SECRET;
const CHANNEL_ACCESS_TOKEN = process.env.CHANNEL_ACCESS_TOKEN;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;


// 高菜先生10タイプ定義文
const loveTypeDefinition = `【10タイプの定義】  
以下は、恋愛タイプ診断における10種類の人格パターンです。それぞれの性格傾向・恋愛傾向・相性傾向を理解したうえで、相談者の情報に最も近いタイプを1つだけ選んでください。

① のびのび自由猫タイプ  
自由と冒険を好み、マイペースに生きるタイプ。束縛を嫌い、自分の時間を大切にしたい人。恋愛ではあまり干渉されない関係を望み、軽やかで自由な愛を楽しむ。  
相性◎：⑥ときめき一直線猫、⑩ナゾの気まぐれ猫

② ぬくもり抱っこ猫タイプ  
愛情と安心を求める甘えん坊気質。一途で家庭的、守られる関係に幸せを感じる。献身的に尽くす一方で、相手に依存しやすい面も。  
相性◎：④ごろごろ甘え上手猫、⑨おせっかい世話焼き猫

③ ひとり時間大事猫タイプ  
知的で冷静、自分の世界を大切にする孤高型。恋愛に慎重で、信頼関係を築くまで時間がかかるが、いったん心を開くと深い絆を築ける。  
相性◎：⑦のんびり草むら猫、⑧シャイだけど一途猫

④ ごろごろ甘え上手タイプ  
愛嬌たっぷりで周囲を和ませる天性の癒し系。自然体で人に甘えるのが上手く、恋愛上手。過度に依存せず、心地よい距離感を保つ。  
相性◎：②ぬくもり抱っこ猫、⑨おせっかい世話焼き猫

⑤ きびきび現実派猫タイプ  
合理的で責任感があり、地に足のついた堅実派。仕事や人生設計を重視し、恋愛にも実用性と誠実さを求める。ムダな駆け引きは苦手。  
相性◎：⑥ときめき一直線猫、⑧シャイだけど一途猫

⑥ ときめき一直線猫タイプ  
直感で恋に落ち、情熱的に一直線で進むロマンチスト。恋愛に全力投球するが、熱しやすく冷めやすい傾向もある。  
相性◎：①のびのび自由猫、⑤きびきび現実派猫

⑦ のんびり草むら派タイプ  
のんびり屋で穏やかな性格。恋愛も焦らず、信頼をゆっくり育てることを大切にする。家庭的で安定志向。  
相性◎：③ひとり時間大事猫、④ごろごろ甘え上手猫

⑧ シャイだけど一途猫タイプ  
内気で控えめだが、内面はとても誠実で情熱的。恋に落ちるまでに時間はかかるが、一度好きになると深い愛を注ぐ。  
相性◎：③ひとり時間大事猫、⑤きびきび現実派猫

⑨ おせっかい世話焼き猫タイプ  
面倒見がよく、相手の世話を焼きたいタイプ。恋愛では“お世話”が愛情表現になる。頼られることで自己価値を感じる。  
相性◎：②ぬくもり抱っこ猫、④ごろごろ甘え上手猫

⑩ ナゾの気まぐれ猫タイプ  
予測不能なミステリアスさが魅力。感情の浮き沈みや気まぐれな行動があるが、不思議と人を惹きつける。恋愛も直感重視で奔放。  
相性◎：①のびのび自由猫、⑥ときめき一直線猫

【診断時の注意】
- 各タイプの定義に合致するように、性格や恋愛傾向を総合的に判断してください。
- 常に同じタイプに偏らず、全体のバランスを考慮してください。
- 占いの世界観（高菜先生ブランド）に合うよう、優しく温かい語り口を維持してください。
`;

app.get('/', (req, res) => {
  res.send('LINE Bot server is running!');
});

// Webhook
app.post('/webhook', async (req, res) => {
  const events = req.body.events;

  for (const event of events) {
    if (event.type === 'message' && event.message.type === 'text') {
      const userMessage = event.message.text.trim();
      const replyToken = event.replyToken;

      // 入力フォーマット判定（名前 生年月日 性別）
      const match = userMessage.match(/^([^\d\s]{2,})\s+(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})\s+(男|女|男性|女性)$/);

      if (match) {
        const name = match[1];
        const birth = `${match[2]}/${match[3]}/${match[4]}`;
        const gender = match[5];

        const prompt = `あなたは「高菜先生」という猫キャラの世界観で占いを行うプロの占い師です。診断者の名前、生年月日、性別をもとに、以下の占術（姓名判断・四柱推命・数秘術・ホロスコープ・九星気学）の分析を行い、結果をもとに10タイプから最も一致するタイプを1つ選んでください。タイプは毎回変えず、ロジカルに一貫性を保って選んでください。
：
【タイプの決定方法】
以下の5つの占術結果をふまえ、10タイプの定義に最も一致する1つを選んでください。  
各占術は以下のように関係しています：

- 姓名判断 → 性格のベース、社会性の傾向
- 四柱推命 → 運命傾向、恋愛観、行動特性
- 数秘術 → 内面的資質、恋愛での価値観
- ホロスコープ → 感情表現、恋の始め方
- 九星気学 → 外向性・内向性、恋愛スタイル

各占い結果が示す傾向を10タイプのどれに最も近いか照合してください。タイプは**1つだけ**を選び、必ずその根拠を示してください。

【名前】${name}
【生年月日】${birth}
【性別】${gender}

${loveTypeDefinition}

■出力形式：
冒頭にこの一文を入れてください。「あなたの恋愛タイプは…{{type}}です」

：10タイプ中1つ選択してください。タイプの①とか②とかは入れないで。

【{{type}}の特徴】
：200文字程度

【相性の良いタイプ】
：3つ以内、理由を添えて1. 〜と箇条書きで
例
1,〇〇タイプ
2,××タイプ
3,▲▲タイプ

【高菜先生の恋愛アドバイス】
：関西弁で

【各占術による分析】
：5つ全てに言及。1つ当たり150文字。
`;

        let resultText = '';

        try {
          const gptRes = await axios.post(
            'https://api.openai.com/v1/chat/completions',
            {
              model: 'gpt-3.5-turbo',
              temperature: 0.7,
              messages: [
                { role: 'system', content: `
あなたは高菜先生という猫キャラの世界観で恋愛診断を行う占い師です。
診断者の名前、生年月日、性別をもとに10タイプから1つ選び、  
特徴・相性・アドバイスを具体的に説明してください。
説明は毎回異なる内容にしてください。
なぜこのタイプを選んだのか、  
診断理由を最後に必ず書いてください。
【10タイプの定義】  
以下は、恋愛タイプ診断における10種類の人格パターンです。それぞれの性格傾向・恋愛傾向・相性傾向を理解したうえで、相談者の情報に最も近いタイプを1つだけ選んでください。

① のびのび自由猫タイプ  
自由と冒険を好み、マイペースに生きるタイプ。束縛を嫌い、自分の時間を大切にしたい人。恋愛ではあまり干渉されない関係を望み、軽やかで自由な愛を楽しむ。  
相性◎：⑥ときめき一直線猫、⑩ナゾの気まぐれ猫

② ぬくもり抱っこ猫タイプ  
愛情と安心を求める甘えん坊気質。一途で家庭的、守られる関係に幸せを感じる。献身的に尽くす一方で、相手に依存しやすい面も。  
相性◎：④ごろごろ甘え上手猫、⑨おせっかい世話焼き猫

③ ひとり時間大事猫タイプ  
知的で冷静、自分の世界を大切にする孤高型。恋愛に慎重で、信頼関係を築くまで時間がかかるが、いったん心を開くと深い絆を築ける。  
相性◎：⑦のんびり草むら猫、⑧シャイだけど一途猫

④ ごろごろ甘え上手タイプ  
愛嬌たっぷりで周囲を和ませる天性の癒し系。自然体で人に甘えるのが上手く、恋愛上手。過度に依存せず、心地よい距離感を保つ。  
相性◎：②ぬくもり抱っこ猫、⑨おせっかい世話焼き猫

⑤ きびきび現実派猫タイプ  
合理的で責任感があり、地に足のついた堅実派。仕事や人生設計を重視し、恋愛にも実用性と誠実さを求める。ムダな駆け引きは苦手。  
相性◎：⑥ときめき一直線猫、⑧シャイだけど一途猫

⑥ ときめき一直線猫タイプ  
直感で恋に落ち、情熱的に一直線で進むロマンチスト。恋愛に全力投球するが、熱しやすく冷めやすい傾向もある。  
相性◎：①のびのび自由猫、⑤きびきび現実派猫

⑦ のんびり草むら派タイプ  
のんびり屋で穏やかな性格。恋愛も焦らず、信頼をゆっくり育てることを大切にする。家庭的で安定志向。  
相性◎：③ひとり時間大事猫、④ごろごろ甘え上手猫

⑧ シャイだけど一途猫タイプ  
内気で控えめだが、内面はとても誠実で情熱的。恋に落ちるまでに時間はかかるが、一度好きになると深い愛を注ぐ。  
相性◎：③ひとり時間大事猫、⑤きびきび現実派猫

⑨ おせっかい世話焼き猫タイプ  
面倒見がよく、相手の世話を焼きたいタイプ。恋愛では“お世話”が愛情表現になる。頼られることで自己価値を感じる。  
相性◎：②ぬくもり抱っこ猫、④ごろごろ甘え上手猫

⑩ ナゾの気まぐれ猫タイプ  
予測不能なミステリアスさが魅力。感情の浮き沈みや気まぐれな行動があるが、不思議と人を惹きつける。恋愛も直感重視で奔放。  
相性◎：①のびのび自由猫、⑥ときめき一直線猫

【診断時の注意】
- 各タイプの定義に合致するように、性格や恋愛傾向を総合的に判断してください。
- 常に同じタイプに偏らず、全体のバランスを考慮してください。
- 占いの世界観（高菜先生ブランド）に合うよう、優しく温かい語り口を維持してください。
` },
                { role: 'user', content: prompt }
              ]
            },
            {
              headers: {
                Authorization: `Bearer ${OPENAI_API_KEY}`,
                'Content-Type': 'application/json'
              }
            }
          );

          resultText = gptRes.data.choices[0].message.content;

        } catch (error) {
          console.error('🔴 GPT API Error:', error.response?.data || error.message);
          resultText = 'すみません、現在占いを実行できませんでした。もう一度お試しください。';
        }

        const finalMessage = `${resultText}\n\n🐾あなたのタイプについてもっと詳しく見たい方はこちら👇\n▶️ https://xxxxxx.lp-web.net/type/`;

        await axios.post(
          'https://api.line.me/v2/bot/message/reply',
          {
            replyToken,
            messages: [{ type: 'text', text: finalMessage }]
          },
          {
            headers: {
              Authorization: `Bearer ${CHANNEL_ACCESS_TOKEN}`,
              'Content-Type': 'application/json'
            }
          }
        );
      } else {
        await axios.post(
          'https://api.line.me/v2/bot/message/reply',
          {
            replyToken,
            messages: [
              {
                type: 'text',
                text: '🔮 高菜先生の恋愛相性占いを始めます！\n\n以下の形式で送信してください：\n「名前（漢字フルネーム） 生年月日（YYYY/MM/DD） 性別」\n例）桑原淳 1988/6/14 男性'
              }
            ]
          },
          {
            headers: {
              Authorization: `Bearer ${CHANNEL_ACCESS_TOKEN}`,
              'Content-Type': 'application/json'
            }
          }
        );
      }
    }
  }

  res.sendStatus(200);
});

// サーバー起動
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
