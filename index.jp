

const express = require('express');
const bodyParser = require('body-parser');
const axios = require('axios');
const app = express();
app.use(bodyParser.json());
// LINEè¨­å®š
require('dotenv').config();

const CHANNEL_SECRET = process.env.CHANNEL_SECRET;
const CHANNEL_ACCESS_TOKEN = process.env.CHANNEL_ACCESS_TOKEN;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;


// é«˜èœå…ˆç”Ÿ10ã‚¿ã‚¤ãƒ—å®šç¾©æ–‡
const loveTypeDefinition = `ã€10ã‚¿ã‚¤ãƒ—ã®å®šç¾©ã€‘  
ä»¥ä¸‹ã¯ã€æ‹æ„›ã‚¿ã‚¤ãƒ—è¨ºæ–­ã«ãŠã‘ã‚‹10ç¨®é¡žã®äººæ ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ãã‚Œãžã‚Œã®æ€§æ ¼å‚¾å‘ãƒ»æ‹æ„›å‚¾å‘ãƒ»ç›¸æ€§å‚¾å‘ã‚’ç†è§£ã—ãŸã†ãˆã§ã€ç›¸è«‡è€…ã®æƒ…å ±ã«æœ€ã‚‚è¿‘ã„ã‚¿ã‚¤ãƒ—ã‚’1ã¤ã ã‘é¸ã‚“ã§ãã ã•ã„ã€‚

â‘  ã®ã³ã®ã³è‡ªç”±çŒ«ã‚¿ã‚¤ãƒ—  
è‡ªç”±ã¨å†’é™ºã‚’å¥½ã¿ã€ãƒžã‚¤ãƒšãƒ¼ã‚¹ã«ç”Ÿãã‚‹ã‚¿ã‚¤ãƒ—ã€‚æŸç¸›ã‚’å«Œã„ã€è‡ªåˆ†ã®æ™‚é–“ã‚’å¤§åˆ‡ã«ã—ãŸã„äººã€‚æ‹æ„›ã§ã¯ã‚ã¾ã‚Šå¹²æ¸‰ã•ã‚Œãªã„é–¢ä¿‚ã‚’æœ›ã¿ã€è»½ã‚„ã‹ã§è‡ªç”±ãªæ„›ã‚’æ¥½ã—ã‚€ã€‚  
ç›¸æ€§â—Žï¼šâ‘¥ã¨ãã‚ãä¸€ç›´ç·šçŒ«ã€â‘©ãƒŠã‚¾ã®æ°—ã¾ãã‚ŒçŒ«

â‘¡ ã¬ãã‚‚ã‚ŠæŠ±ã£ã“çŒ«ã‚¿ã‚¤ãƒ—  
æ„›æƒ…ã¨å®‰å¿ƒã‚’æ±‚ã‚ã‚‹ç”˜ãˆã‚“åŠæ°—è³ªã€‚ä¸€é€”ã§å®¶åº­çš„ã€å®ˆã‚‰ã‚Œã‚‹é–¢ä¿‚ã«å¹¸ã›ã‚’æ„Ÿã˜ã‚‹ã€‚çŒ®èº«çš„ã«å°½ãã™ä¸€æ–¹ã§ã€ç›¸æ‰‹ã«ä¾å­˜ã—ã‚„ã™ã„é¢ã‚‚ã€‚  
ç›¸æ€§â—Žï¼šâ‘£ã”ã‚ã”ã‚ç”˜ãˆä¸Šæ‰‹çŒ«ã€â‘¨ãŠã›ã£ã‹ã„ä¸–è©±ç„¼ãçŒ«

â‘¢ ã²ã¨ã‚Šæ™‚é–“å¤§äº‹çŒ«ã‚¿ã‚¤ãƒ—  
çŸ¥çš„ã§å†·é™ã€è‡ªåˆ†ã®ä¸–ç•Œã‚’å¤§åˆ‡ã«ã™ã‚‹å­¤é«˜åž‹ã€‚æ‹æ„›ã«æ…Žé‡ã§ã€ä¿¡é ¼é–¢ä¿‚ã‚’ç¯‰ãã¾ã§æ™‚é–“ãŒã‹ã‹ã‚‹ãŒã€ã„ã£ãŸã‚“å¿ƒã‚’é–‹ãã¨æ·±ã„çµ†ã‚’ç¯‰ã‘ã‚‹ã€‚  
ç›¸æ€§â—Žï¼šâ‘¦ã®ã‚“ã³ã‚Šè‰ã‚€ã‚‰çŒ«ã€â‘§ã‚·ãƒ£ã‚¤ã ã‘ã©ä¸€é€”çŒ«

â‘£ ã”ã‚ã”ã‚ç”˜ãˆä¸Šæ‰‹ã‚¿ã‚¤ãƒ—  
æ„›å¬ŒãŸã£ã·ã‚Šã§å‘¨å›²ã‚’å’Œã¾ã›ã‚‹å¤©æ€§ã®ç™’ã—ç³»ã€‚è‡ªç„¶ä½“ã§äººã«ç”˜ãˆã‚‹ã®ãŒä¸Šæ‰‹ãã€æ‹æ„›ä¸Šæ‰‹ã€‚éŽåº¦ã«ä¾å­˜ã›ãšã€å¿ƒåœ°ã‚ˆã„è·é›¢æ„Ÿã‚’ä¿ã¤ã€‚  
ç›¸æ€§â—Žï¼šâ‘¡ã¬ãã‚‚ã‚ŠæŠ±ã£ã“çŒ«ã€â‘¨ãŠã›ã£ã‹ã„ä¸–è©±ç„¼ãçŒ«

â‘¤ ãã³ãã³ç¾å®Ÿæ´¾çŒ«ã‚¿ã‚¤ãƒ—  
åˆç†çš„ã§è²¬ä»»æ„ŸãŒã‚ã‚Šã€åœ°ã«è¶³ã®ã¤ã„ãŸå …å®Ÿæ´¾ã€‚ä»•äº‹ã‚„äººç”Ÿè¨­è¨ˆã‚’é‡è¦–ã—ã€æ‹æ„›ã«ã‚‚å®Ÿç”¨æ€§ã¨èª å®Ÿã•ã‚’æ±‚ã‚ã‚‹ã€‚ãƒ ãƒ€ãªé§†ã‘å¼•ãã¯è‹¦æ‰‹ã€‚  
ç›¸æ€§â—Žï¼šâ‘¥ã¨ãã‚ãä¸€ç›´ç·šçŒ«ã€â‘§ã‚·ãƒ£ã‚¤ã ã‘ã©ä¸€é€”çŒ«

â‘¥ ã¨ãã‚ãä¸€ç›´ç·šçŒ«ã‚¿ã‚¤ãƒ—  
ç›´æ„Ÿã§æ‹ã«è½ã¡ã€æƒ…ç†±çš„ã«ä¸€ç›´ç·šã§é€²ã‚€ãƒ­ãƒžãƒ³ãƒã‚¹ãƒˆã€‚æ‹æ„›ã«å…¨åŠ›æŠ•çƒã™ã‚‹ãŒã€ç†±ã—ã‚„ã™ãå†·ã‚ã‚„ã™ã„å‚¾å‘ã‚‚ã‚ã‚‹ã€‚  
ç›¸æ€§â—Žï¼šâ‘ ã®ã³ã®ã³è‡ªç”±çŒ«ã€â‘¤ãã³ãã³ç¾å®Ÿæ´¾çŒ«

â‘¦ ã®ã‚“ã³ã‚Šè‰ã‚€ã‚‰æ´¾ã‚¿ã‚¤ãƒ—  
ã®ã‚“ã³ã‚Šå±‹ã§ç©ã‚„ã‹ãªæ€§æ ¼ã€‚æ‹æ„›ã‚‚ç„¦ã‚‰ãšã€ä¿¡é ¼ã‚’ã‚†ã£ãã‚Šè‚²ã¦ã‚‹ã“ã¨ã‚’å¤§åˆ‡ã«ã™ã‚‹ã€‚å®¶åº­çš„ã§å®‰å®šå¿—å‘ã€‚  
ç›¸æ€§â—Žï¼šâ‘¢ã²ã¨ã‚Šæ™‚é–“å¤§äº‹çŒ«ã€â‘£ã”ã‚ã”ã‚ç”˜ãˆä¸Šæ‰‹çŒ«

â‘§ ã‚·ãƒ£ã‚¤ã ã‘ã©ä¸€é€”çŒ«ã‚¿ã‚¤ãƒ—  
å†…æ°—ã§æŽ§ãˆã‚ã ãŒã€å†…é¢ã¯ã¨ã¦ã‚‚èª å®Ÿã§æƒ…ç†±çš„ã€‚æ‹ã«è½ã¡ã‚‹ã¾ã§ã«æ™‚é–“ã¯ã‹ã‹ã‚‹ãŒã€ä¸€åº¦å¥½ãã«ãªã‚‹ã¨æ·±ã„æ„›ã‚’æ³¨ãã€‚  
ç›¸æ€§â—Žï¼šâ‘¢ã²ã¨ã‚Šæ™‚é–“å¤§äº‹çŒ«ã€â‘¤ãã³ãã³ç¾å®Ÿæ´¾çŒ«

â‘¨ ãŠã›ã£ã‹ã„ä¸–è©±ç„¼ãçŒ«ã‚¿ã‚¤ãƒ—  
é¢å€’è¦‹ãŒã‚ˆãã€ç›¸æ‰‹ã®ä¸–è©±ã‚’ç„¼ããŸã„ã‚¿ã‚¤ãƒ—ã€‚æ‹æ„›ã§ã¯â€œãŠä¸–è©±â€ãŒæ„›æƒ…è¡¨ç¾ã«ãªã‚‹ã€‚é ¼ã‚‰ã‚Œã‚‹ã“ã¨ã§è‡ªå·±ä¾¡å€¤ã‚’æ„Ÿã˜ã‚‹ã€‚  
ç›¸æ€§â—Žï¼šâ‘¡ã¬ãã‚‚ã‚ŠæŠ±ã£ã“çŒ«ã€â‘£ã”ã‚ã”ã‚ç”˜ãˆä¸Šæ‰‹çŒ«

â‘© ãƒŠã‚¾ã®æ°—ã¾ãã‚ŒçŒ«ã‚¿ã‚¤ãƒ—  
äºˆæ¸¬ä¸èƒ½ãªãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ã•ãŒé­…åŠ›ã€‚æ„Ÿæƒ…ã®æµ®ãæ²ˆã¿ã‚„æ°—ã¾ãã‚Œãªè¡Œå‹•ãŒã‚ã‚‹ãŒã€ä¸æ€è­°ã¨äººã‚’æƒ¹ãã¤ã‘ã‚‹ã€‚æ‹æ„›ã‚‚ç›´æ„Ÿé‡è¦–ã§å¥”æ”¾ã€‚  
ç›¸æ€§â—Žï¼šâ‘ ã®ã³ã®ã³è‡ªç”±çŒ«ã€â‘¥ã¨ãã‚ãä¸€ç›´ç·šçŒ«

ã€è¨ºæ–­æ™‚ã®æ³¨æ„ã€‘
- å„ã‚¿ã‚¤ãƒ—ã®å®šç¾©ã«åˆè‡´ã™ã‚‹ã‚ˆã†ã«ã€æ€§æ ¼ã‚„æ‹æ„›å‚¾å‘ã‚’ç·åˆçš„ã«åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚
- å¸¸ã«åŒã˜ã‚¿ã‚¤ãƒ—ã«åã‚‰ãšã€å…¨ä½“ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…®ã—ã¦ãã ã•ã„ã€‚
- å ã„ã®ä¸–ç•Œè¦³ï¼ˆé«˜èœå…ˆç”Ÿãƒ–ãƒ©ãƒ³ãƒ‰ï¼‰ã«åˆã†ã‚ˆã†ã€å„ªã—ãæ¸©ã‹ã„èªžã‚Šå£ã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚
`;

app.get('/', (req, res) => {
  res.send('LINE Bot server is running!');
});

// Webhook
app.post('/webhook', async (req, res) => {
  const events = req.body.events;

  for (const event of events) {
    if (event.type === 'message' && event.message.type === 'text') {
      const userMessage = event.message.text.trim();
      const replyToken = event.replyToken;

      // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆåˆ¤å®šï¼ˆåå‰ ç”Ÿå¹´æœˆæ—¥ æ€§åˆ¥ï¼‰
      const match = userMessage.match(/^([^\d\s]{2,})\s+(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})\s+(ç”·|å¥³|ç”·æ€§|å¥³æ€§)$/);

      if (match) {
        const name = match[1];
        const birth = `${match[2]}/${match[3]}/${match[4]}`;
        const gender = match[5];

        const prompt = `ã‚ãªãŸã¯ã€Œé«˜èœå…ˆç”Ÿã€ã¨ã„ã†çŒ«ã‚­ãƒ£ãƒ©ã®ä¸–ç•Œè¦³ã§å ã„ã‚’è¡Œã†ãƒ—ãƒ­ã®å ã„å¸«ã§ã™ã€‚è¨ºæ–­è€…ã®åå‰ã€ç”Ÿå¹´æœˆæ—¥ã€æ€§åˆ¥ã‚’ã‚‚ã¨ã«ã€ä»¥ä¸‹ã®å è¡“ï¼ˆå§“ååˆ¤æ–­ãƒ»å››æŸ±æŽ¨å‘½ãƒ»æ•°ç§˜è¡“ãƒ»ãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ãƒ»ä¹æ˜Ÿæ°—å­¦ï¼‰ã®åˆ†æžã‚’è¡Œã„ã€çµæžœã‚’ã‚‚ã¨ã«10ã‚¿ã‚¤ãƒ—ã‹ã‚‰æœ€ã‚‚ä¸€è‡´ã™ã‚‹ã‚¿ã‚¤ãƒ—ã‚’1ã¤é¸ã‚“ã§ãã ã•ã„ã€‚ã‚¿ã‚¤ãƒ—ã¯æ¯Žå›žå¤‰ãˆãšã€ãƒ­ã‚¸ã‚«ãƒ«ã«ä¸€è²«æ€§ã‚’ä¿ã£ã¦é¸ã‚“ã§ãã ã•ã„ã€‚
ï¼š
ã€ã‚¿ã‚¤ãƒ—ã®æ±ºå®šæ–¹æ³•ã€‘
ä»¥ä¸‹ã®5ã¤ã®å è¡“çµæžœã‚’ãµã¾ãˆã€10ã‚¿ã‚¤ãƒ—ã®å®šç¾©ã«æœ€ã‚‚ä¸€è‡´ã™ã‚‹1ã¤ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚  
å„å è¡“ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«é–¢ä¿‚ã—ã¦ã„ã¾ã™ï¼š

- å§“ååˆ¤æ–­ â†’ æ€§æ ¼ã®ãƒ™ãƒ¼ã‚¹ã€ç¤¾ä¼šæ€§ã®å‚¾å‘
- å››æŸ±æŽ¨å‘½ â†’ é‹å‘½å‚¾å‘ã€æ‹æ„›è¦³ã€è¡Œå‹•ç‰¹æ€§
- æ•°ç§˜è¡“ â†’ å†…é¢çš„è³‡è³ªã€æ‹æ„›ã§ã®ä¾¡å€¤è¦³
- ãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ— â†’ æ„Ÿæƒ…è¡¨ç¾ã€æ‹ã®å§‹ã‚æ–¹
- ä¹æ˜Ÿæ°—å­¦ â†’ å¤–å‘æ€§ãƒ»å†…å‘æ€§ã€æ‹æ„›ã‚¹ã‚¿ã‚¤ãƒ«

å„å ã„çµæžœãŒç¤ºã™å‚¾å‘ã‚’10ã‚¿ã‚¤ãƒ—ã®ã©ã‚Œã«æœ€ã‚‚è¿‘ã„ã‹ç…§åˆã—ã¦ãã ã•ã„ã€‚ã‚¿ã‚¤ãƒ—ã¯**1ã¤ã ã‘**ã‚’é¸ã³ã€å¿…ãšãã®æ ¹æ‹ ã‚’ç¤ºã—ã¦ãã ã•ã„ã€‚

ã€åå‰ã€‘${name}
ã€ç”Ÿå¹´æœˆæ—¥ã€‘${birth}
ã€æ€§åˆ¥ã€‘${gender}

${loveTypeDefinition}

â– å‡ºåŠ›å½¢å¼ï¼š
å†’é ­ã«ã“ã®ä¸€æ–‡ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚ã€Œã‚ãªãŸã®æ‹æ„›ã‚¿ã‚¤ãƒ—ã¯â€¦{{type}}ã§ã™ã€

ï¼š10ã‚¿ã‚¤ãƒ—ä¸­1ã¤é¸æŠžã—ã¦ãã ã•ã„ã€‚ã‚¿ã‚¤ãƒ—ã®â‘ ã¨ã‹â‘¡ã¨ã‹ã¯å…¥ã‚Œãªã„ã§ã€‚

ã€{{type}}ã®ç‰¹å¾´ã€‘
ï¼š200æ–‡å­—ç¨‹åº¦

ã€ç›¸æ€§ã®è‰¯ã„ã‚¿ã‚¤ãƒ—ã€‘
ï¼š3ã¤ä»¥å†…ã€ç†ç”±ã‚’æ·»ãˆã¦1. ã€œã¨ç®‡æ¡æ›¸ãã§
ä¾‹
1,ã€‡ã€‡ã‚¿ã‚¤ãƒ—
2,Ã—Ã—ã‚¿ã‚¤ãƒ—
3,â–²â–²ã‚¿ã‚¤ãƒ—

ã€é«˜èœå…ˆç”Ÿã®æ‹æ„›ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‘
ï¼šé–¢è¥¿å¼ã§

ã€å„å è¡“ã«ã‚ˆã‚‹åˆ†æžã€‘
ï¼š5ã¤å…¨ã¦ã«è¨€åŠã€‚1ã¤å½“ãŸã‚Š150æ–‡å­—ã€‚
`;

        let resultText = '';

        try {
          const gptRes = await axios.post(
            'https://api.openai.com/v1/chat/completions',
            {
              model: 'gpt-3.5-turbo',
              temperature: 0.7,
              messages: [
                { role: 'system', content: `
ã‚ãªãŸã¯é«˜èœå…ˆç”Ÿã¨ã„ã†çŒ«ã‚­ãƒ£ãƒ©ã®ä¸–ç•Œè¦³ã§æ‹æ„›è¨ºæ–­ã‚’è¡Œã†å ã„å¸«ã§ã™ã€‚
è¨ºæ–­è€…ã®åå‰ã€ç”Ÿå¹´æœˆæ—¥ã€æ€§åˆ¥ã‚’ã‚‚ã¨ã«10ã‚¿ã‚¤ãƒ—ã‹ã‚‰1ã¤é¸ã³ã€  
ç‰¹å¾´ãƒ»ç›¸æ€§ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å…·ä½“çš„ã«èª¬æ˜Žã—ã¦ãã ã•ã„ã€‚
èª¬æ˜Žã¯æ¯Žå›žç•°ãªã‚‹å†…å®¹ã«ã—ã¦ãã ã•ã„ã€‚
ãªãœã“ã®ã‚¿ã‚¤ãƒ—ã‚’é¸ã‚“ã ã®ã‹ã€  
è¨ºæ–­ç†ç”±ã‚’æœ€å¾Œã«å¿…ãšæ›¸ã„ã¦ãã ã•ã„ã€‚
ã€10ã‚¿ã‚¤ãƒ—ã®å®šç¾©ã€‘  
ä»¥ä¸‹ã¯ã€æ‹æ„›ã‚¿ã‚¤ãƒ—è¨ºæ–­ã«ãŠã‘ã‚‹10ç¨®é¡žã®äººæ ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ãã‚Œãžã‚Œã®æ€§æ ¼å‚¾å‘ãƒ»æ‹æ„›å‚¾å‘ãƒ»ç›¸æ€§å‚¾å‘ã‚’ç†è§£ã—ãŸã†ãˆã§ã€ç›¸è«‡è€…ã®æƒ…å ±ã«æœ€ã‚‚è¿‘ã„ã‚¿ã‚¤ãƒ—ã‚’1ã¤ã ã‘é¸ã‚“ã§ãã ã•ã„ã€‚

â‘  ã®ã³ã®ã³è‡ªç”±çŒ«ã‚¿ã‚¤ãƒ—  
è‡ªç”±ã¨å†’é™ºã‚’å¥½ã¿ã€ãƒžã‚¤ãƒšãƒ¼ã‚¹ã«ç”Ÿãã‚‹ã‚¿ã‚¤ãƒ—ã€‚æŸç¸›ã‚’å«Œã„ã€è‡ªåˆ†ã®æ™‚é–“ã‚’å¤§åˆ‡ã«ã—ãŸã„äººã€‚æ‹æ„›ã§ã¯ã‚ã¾ã‚Šå¹²æ¸‰ã•ã‚Œãªã„é–¢ä¿‚ã‚’æœ›ã¿ã€è»½ã‚„ã‹ã§è‡ªç”±ãªæ„›ã‚’æ¥½ã—ã‚€ã€‚  
ç›¸æ€§â—Žï¼šâ‘¥ã¨ãã‚ãä¸€ç›´ç·šçŒ«ã€â‘©ãƒŠã‚¾ã®æ°—ã¾ãã‚ŒçŒ«

â‘¡ ã¬ãã‚‚ã‚ŠæŠ±ã£ã“çŒ«ã‚¿ã‚¤ãƒ—  
æ„›æƒ…ã¨å®‰å¿ƒã‚’æ±‚ã‚ã‚‹ç”˜ãˆã‚“åŠæ°—è³ªã€‚ä¸€é€”ã§å®¶åº­çš„ã€å®ˆã‚‰ã‚Œã‚‹é–¢ä¿‚ã«å¹¸ã›ã‚’æ„Ÿã˜ã‚‹ã€‚çŒ®èº«çš„ã«å°½ãã™ä¸€æ–¹ã§ã€ç›¸æ‰‹ã«ä¾å­˜ã—ã‚„ã™ã„é¢ã‚‚ã€‚  
ç›¸æ€§â—Žï¼šâ‘£ã”ã‚ã”ã‚ç”˜ãˆä¸Šæ‰‹çŒ«ã€â‘¨ãŠã›ã£ã‹ã„ä¸–è©±ç„¼ãçŒ«

â‘¢ ã²ã¨ã‚Šæ™‚é–“å¤§äº‹çŒ«ã‚¿ã‚¤ãƒ—  
çŸ¥çš„ã§å†·é™ã€è‡ªåˆ†ã®ä¸–ç•Œã‚’å¤§åˆ‡ã«ã™ã‚‹å­¤é«˜åž‹ã€‚æ‹æ„›ã«æ…Žé‡ã§ã€ä¿¡é ¼é–¢ä¿‚ã‚’ç¯‰ãã¾ã§æ™‚é–“ãŒã‹ã‹ã‚‹ãŒã€ã„ã£ãŸã‚“å¿ƒã‚’é–‹ãã¨æ·±ã„çµ†ã‚’ç¯‰ã‘ã‚‹ã€‚  
ç›¸æ€§â—Žï¼šâ‘¦ã®ã‚“ã³ã‚Šè‰ã‚€ã‚‰çŒ«ã€â‘§ã‚·ãƒ£ã‚¤ã ã‘ã©ä¸€é€”çŒ«

â‘£ ã”ã‚ã”ã‚ç”˜ãˆä¸Šæ‰‹ã‚¿ã‚¤ãƒ—  
æ„›å¬ŒãŸã£ã·ã‚Šã§å‘¨å›²ã‚’å’Œã¾ã›ã‚‹å¤©æ€§ã®ç™’ã—ç³»ã€‚è‡ªç„¶ä½“ã§äººã«ç”˜ãˆã‚‹ã®ãŒä¸Šæ‰‹ãã€æ‹æ„›ä¸Šæ‰‹ã€‚éŽåº¦ã«ä¾å­˜ã›ãšã€å¿ƒåœ°ã‚ˆã„è·é›¢æ„Ÿã‚’ä¿ã¤ã€‚  
ç›¸æ€§â—Žï¼šâ‘¡ã¬ãã‚‚ã‚ŠæŠ±ã£ã“çŒ«ã€â‘¨ãŠã›ã£ã‹ã„ä¸–è©±ç„¼ãçŒ«

â‘¤ ãã³ãã³ç¾å®Ÿæ´¾çŒ«ã‚¿ã‚¤ãƒ—  
åˆç†çš„ã§è²¬ä»»æ„ŸãŒã‚ã‚Šã€åœ°ã«è¶³ã®ã¤ã„ãŸå …å®Ÿæ´¾ã€‚ä»•äº‹ã‚„äººç”Ÿè¨­è¨ˆã‚’é‡è¦–ã—ã€æ‹æ„›ã«ã‚‚å®Ÿç”¨æ€§ã¨èª å®Ÿã•ã‚’æ±‚ã‚ã‚‹ã€‚ãƒ ãƒ€ãªé§†ã‘å¼•ãã¯è‹¦æ‰‹ã€‚  
ç›¸æ€§â—Žï¼šâ‘¥ã¨ãã‚ãä¸€ç›´ç·šçŒ«ã€â‘§ã‚·ãƒ£ã‚¤ã ã‘ã©ä¸€é€”çŒ«

â‘¥ ã¨ãã‚ãä¸€ç›´ç·šçŒ«ã‚¿ã‚¤ãƒ—  
ç›´æ„Ÿã§æ‹ã«è½ã¡ã€æƒ…ç†±çš„ã«ä¸€ç›´ç·šã§é€²ã‚€ãƒ­ãƒžãƒ³ãƒã‚¹ãƒˆã€‚æ‹æ„›ã«å…¨åŠ›æŠ•çƒã™ã‚‹ãŒã€ç†±ã—ã‚„ã™ãå†·ã‚ã‚„ã™ã„å‚¾å‘ã‚‚ã‚ã‚‹ã€‚  
ç›¸æ€§â—Žï¼šâ‘ ã®ã³ã®ã³è‡ªç”±çŒ«ã€â‘¤ãã³ãã³ç¾å®Ÿæ´¾çŒ«

â‘¦ ã®ã‚“ã³ã‚Šè‰ã‚€ã‚‰æ´¾ã‚¿ã‚¤ãƒ—  
ã®ã‚“ã³ã‚Šå±‹ã§ç©ã‚„ã‹ãªæ€§æ ¼ã€‚æ‹æ„›ã‚‚ç„¦ã‚‰ãšã€ä¿¡é ¼ã‚’ã‚†ã£ãã‚Šè‚²ã¦ã‚‹ã“ã¨ã‚’å¤§åˆ‡ã«ã™ã‚‹ã€‚å®¶åº­çš„ã§å®‰å®šå¿—å‘ã€‚  
ç›¸æ€§â—Žï¼šâ‘¢ã²ã¨ã‚Šæ™‚é–“å¤§äº‹çŒ«ã€â‘£ã”ã‚ã”ã‚ç”˜ãˆä¸Šæ‰‹çŒ«

â‘§ ã‚·ãƒ£ã‚¤ã ã‘ã©ä¸€é€”çŒ«ã‚¿ã‚¤ãƒ—  
å†…æ°—ã§æŽ§ãˆã‚ã ãŒã€å†…é¢ã¯ã¨ã¦ã‚‚èª å®Ÿã§æƒ…ç†±çš„ã€‚æ‹ã«è½ã¡ã‚‹ã¾ã§ã«æ™‚é–“ã¯ã‹ã‹ã‚‹ãŒã€ä¸€åº¦å¥½ãã«ãªã‚‹ã¨æ·±ã„æ„›ã‚’æ³¨ãã€‚  
ç›¸æ€§â—Žï¼šâ‘¢ã²ã¨ã‚Šæ™‚é–“å¤§äº‹çŒ«ã€â‘¤ãã³ãã³ç¾å®Ÿæ´¾çŒ«

â‘¨ ãŠã›ã£ã‹ã„ä¸–è©±ç„¼ãçŒ«ã‚¿ã‚¤ãƒ—  
é¢å€’è¦‹ãŒã‚ˆãã€ç›¸æ‰‹ã®ä¸–è©±ã‚’ç„¼ããŸã„ã‚¿ã‚¤ãƒ—ã€‚æ‹æ„›ã§ã¯â€œãŠä¸–è©±â€ãŒæ„›æƒ…è¡¨ç¾ã«ãªã‚‹ã€‚é ¼ã‚‰ã‚Œã‚‹ã“ã¨ã§è‡ªå·±ä¾¡å€¤ã‚’æ„Ÿã˜ã‚‹ã€‚  
ç›¸æ€§â—Žï¼šâ‘¡ã¬ãã‚‚ã‚ŠæŠ±ã£ã“çŒ«ã€â‘£ã”ã‚ã”ã‚ç”˜ãˆä¸Šæ‰‹çŒ«

â‘© ãƒŠã‚¾ã®æ°—ã¾ãã‚ŒçŒ«ã‚¿ã‚¤ãƒ—  
äºˆæ¸¬ä¸èƒ½ãªãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ã•ãŒé­…åŠ›ã€‚æ„Ÿæƒ…ã®æµ®ãæ²ˆã¿ã‚„æ°—ã¾ãã‚Œãªè¡Œå‹•ãŒã‚ã‚‹ãŒã€ä¸æ€è­°ã¨äººã‚’æƒ¹ãã¤ã‘ã‚‹ã€‚æ‹æ„›ã‚‚ç›´æ„Ÿé‡è¦–ã§å¥”æ”¾ã€‚  
ç›¸æ€§â—Žï¼šâ‘ ã®ã³ã®ã³è‡ªç”±çŒ«ã€â‘¥ã¨ãã‚ãä¸€ç›´ç·šçŒ«

ã€è¨ºæ–­æ™‚ã®æ³¨æ„ã€‘
- å„ã‚¿ã‚¤ãƒ—ã®å®šç¾©ã«åˆè‡´ã™ã‚‹ã‚ˆã†ã«ã€æ€§æ ¼ã‚„æ‹æ„›å‚¾å‘ã‚’ç·åˆçš„ã«åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚
- å¸¸ã«åŒã˜ã‚¿ã‚¤ãƒ—ã«åã‚‰ãšã€å…¨ä½“ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…®ã—ã¦ãã ã•ã„ã€‚
- å ã„ã®ä¸–ç•Œè¦³ï¼ˆé«˜èœå…ˆç”Ÿãƒ–ãƒ©ãƒ³ãƒ‰ï¼‰ã«åˆã†ã‚ˆã†ã€å„ªã—ãæ¸©ã‹ã„èªžã‚Šå£ã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚
` },
                { role: 'user', content: prompt }
              ]
            },
            {
              headers: {
                Authorization: `Bearer ${OPENAI_API_KEY}`,
                'Content-Type': 'application/json'
              }
            }
          );

          resultText = gptRes.data.choices[0].message.content;

        } catch (error) {
          console.error('ðŸ”´ GPT API Error:', error.response?.data || error.message);
          resultText = 'ã™ã¿ã¾ã›ã‚“ã€ç¾åœ¨å ã„ã‚’å®Ÿè¡Œã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        }

        const finalMessage = `${resultText}\n\nðŸ¾ã‚ãªãŸã®ã‚¿ã‚¤ãƒ—ã«ã¤ã„ã¦ã‚‚ã£ã¨è©³ã—ãè¦‹ãŸã„æ–¹ã¯ã“ã¡ã‚‰ðŸ‘‡\nâ–¶ï¸ https://xxxxxx.lp-web.net/type/`;

        await axios.post(
          'https://api.line.me/v2/bot/message/reply',
          {
            replyToken,
            messages: [{ type: 'text', text: finalMessage }]
          },
          {
            headers: {
              Authorization: `Bearer ${CHANNEL_ACCESS_TOKEN}`,
              'Content-Type': 'application/json'
            }
          }
        );
      } else {
        await axios.post(
          'https://api.line.me/v2/bot/message/reply',
          {
            replyToken,
            messages: [
              {
                type: 'text',
                text: 'ðŸ”® é«˜èœå…ˆç”Ÿã®æ‹æ„›ç›¸æ€§å ã„ã‚’å§‹ã‚ã¾ã™ï¼\n\nä»¥ä¸‹ã®å½¢å¼ã§é€ä¿¡ã—ã¦ãã ã•ã„ï¼š\nã€Œåå‰ï¼ˆæ¼¢å­—ãƒ•ãƒ«ãƒãƒ¼ãƒ ï¼‰ ç”Ÿå¹´æœˆæ—¥ï¼ˆYYYY/MM/DDï¼‰ æ€§åˆ¥ã€\nä¾‹ï¼‰æ¡‘åŽŸæ·³ 1988/6/14 ç”·æ€§'
              }
            ]
          },
          {
            headers: {
              Authorization: `Bearer ${CHANNEL_ACCESS_TOKEN}`,
              'Content-Type': 'application/json'
            }
          }
        );
      }
    }
  }

  res.sendStatus(200);
});

// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
